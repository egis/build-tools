machine:
  pre:
    - mkdir ~/.cache/yarn
  node:
    version: 7.0.0
  ruby:
    version: 2.4.1

dependencies:
  cache_directories:
    - ~/.cache/yarn
  pre:
    - if [ "${CIRCLE_BRANCH}" != "master" ]; then rm .npmrc; fi
    - npm install yarn@0.27.5
  override:
    - node_modules/.bin/yarn
    - if [ "${CIRCLE_BRANCH}" == "master" ]; then node_modules/.bin/yarn global add @artemv/dont-break@1.11.0-pre.2; fi
  post:
    - node --version
    - npm --version

test:
  override:
    - npm test
    - node merge-build-tools-deps.js && git checkout -- package.json
    - if [ "${CIRCLE_BRANCH}" == "master" ]; then (cp -f .npmrc ~) && (dont-break --timeout 600); fi
  post:
    - if [ "${CIRCLE_BRANCH}" == "master" ]; then rm ~/.npmrc; fi
    - grep "version\"\:" node_modules/*/*/package.json > $CIRCLE_ARTIFACTS/npm_versions.txt
    - grep "version\"\:" node_modules/*/package.json >> $CIRCLE_ARTIFACTS/npm_versions.txt
    - grep "version\"\:" node_modules/*/*/*/package.json >> $CIRCLE_ARTIFACTS/npm_versions.txt
    - cp yarn.lock $CIRCLE_ARTIFACTS

deployment:
  semantic-release:
    branch: master
    owner: egis
    commands:
      - npm run semantic-release || true

