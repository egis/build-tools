machine:
  pre:
    - mkdir ~/.cache/yarn
  node:
    version: 4.2.6
  ruby:
    version: 2.4.1

dependencies:
  cache_directories:
    - ~/.cache/yarn
  pre:
    - test $CIRCLE_BRANCH != master && rm .npmrc || true
  override:
    - gem install sass
    - npm rebuild node-sass
    - nvm install v7.0.0
    - (yarn --version) || npm install -g yarn
  post:
    - node --version
    - npm --version

test:
  override:
    - yarn --ignore-engines && npm test
    - nvm use 7.0.0 && npm rebuild node-sass && npm install -g yarn && yarn && npm test
    - nvm use 7.0.0 && npm run browsersync:
          background: true
    - if [[ $CIRCLE_BRANCH = master ]]; then (cp -f .npmrc ~) && (npm run dont-break); fi
  post:
    - if [[ $CIRCLE_BRANCH = master ]]; then rm ~/.npmrc; fi
    - cp yarn.lock $CIRCLE_ARTIFACTS

deployment:
  semantic-release:
    branch: master
    commands:
      - npm run semantic-release || true

